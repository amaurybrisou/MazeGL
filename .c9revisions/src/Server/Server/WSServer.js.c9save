{"ts":1370615948493,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var WebSocketServer = require('websocket').server;\nvar http = require('http');\nvar ServerRequest = require('./WSServerRequest.js').ServerRequest;\nvar Client = require('../Client/Client.js').Client;\n\nvar WSServer = (function(){\n\tvar http_server = http.createServer(function(request, response) {})\n\tvar return_data, recv_data;\n\tvar Clients = [];\n\t\n\treturn function(address, port){\t\n\t\thttp_server.listen(port, address, function() {\n\t\t\tvar address = http_server.address();\n\t\t\tconsole.log(\"WebSocket Server Bound on \"+address.address+\":\"+address.port);\n\t\t});\n\n\t\t// create the http_server\n\t\tvar wsServer = new WebSocketServer({\n\t\t\thttpServer: http_server\n\t\t});\n\n\t\twsServer.on('request', function(request) {\n\t\t\t//Keep connection, new_client and con variables here.\n\t\t\t//in order to avoir connection conflicts.\n\t\t\t//New client() could be avoided in the futur, replaced by Client()\n\t\t\t//only.\n\t\t\tconsole.log((new Date()) + ' Connection from origin '\n\t\t\t\t+ request.origin + '.');\n\n\t\t\tvar connection = request.accept();\n\n\t\t\tvar new_client = { con : connection, cli : new Client() };\n\t\t\tClients.push(new_client);\n\n\t\t\tvar con;\n\t\t\tconnection.on('message', function(message) {\n\t\t\t\tif (message.type === 'utf8' && message.utf8Data !== \"\") {\n\t\t\t\t\trecv_data = JSON.parse(message.utf8Data);\n\t\t\t\t\treturn_data = ServerRequest(new_client, recv_data);\n\t\t\t\t\tif(return_data !== undefined){\n                        setTimeout(function() {\n                            new_client.con.send(JSON.stringify(return_data))    \n                        }, 3);\n\t\t\t\t\t\t\n\t\t\t\t\t\t// for(a_cli in Clients){\n\t\t\t\t\t\t// \tcon = Clients[a_cli].con;\n\t\t\t\t\t\t// \tcon.send(JSON.stringify(return_data));\n\t\t\t\t\t\t// }\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tconnection.on(\"close\", function(connection){\n\t\t\t\tconsole.log((new Date()) + \" Peer disconnected.\");\n\t\t\t});\n\t\t});\n\t\treturn wsServer;\n\t};\n}());\n\nmodule.exports = WSServer;\n"]],"start1":0,"start2":0,"length1":0,"length2":1853}]],"length":1853}
